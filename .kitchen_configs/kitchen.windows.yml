---
driver:
  name: azurerm
  subscription_id: <%= ENV['AZURE_SUBSCRIPTION_ID'] %>

provisioner:
  name: shell
  script: .kitchen/provision_windows.ps1

verifier:
  name: serverspec
  remote_exec: false
  color: <%= !ENV.include?('CI') %>

transport:
  name: winrm
  env_variables:
    PUPPET_ROLE: <%= ENV['PUPPET_ROLE'] %>
    RONIN_REF: <%= ENV['RONIN_REF'] %>

platforms:
  - name: win11-64-25h2
    driver:
      name: azurerm
      location: 'East US 2'
      machine_size: 'Standard_F8s_v2'
      image_urn: MicrosoftWindowsDesktop:windows-11:win11-25h2-ent:latest
      azure_resource_group_name: ronin-puppet-test-kitchen
      use_ephemeral_osdisk: true
      vm_tags:
        owner: relops@mozilla.com
        provisioner: test-kitchen-azurerm
      winrm_powershell_script: |-
        Set-NetConnectionProfile -NetworkCategory Private
        winrm quickconfig -q
        winrm set winrm/config/winrs '@{MaxMemoryPerShellMB="512"}'
        winrm set winrm/config '@{MaxTimeoutms="1800000"}'
        winrm set winrm/config/service '@{AllowUnencrypted="true"}'
        winrm set winrm/config/service/auth '@{Basic="true"}'
    transport:
      name: winrm

suites:
  - name: windows
    verifier:
      patterns:
        - test/integration/<%= ENV['PUPPET_ROLE'] %>/serverspec/*_spec.rb
      default_pattern: false
      extra_flags: --format RspecJunitFormatter -o rspec/rspec.xml
    includes:
      - win11-64-25h2
