---
driver:
  name: azurerm
  subscription_id: <%= ENV['AZURE_SUBSCRIPTION_ID'] %>

provisioner:
  name: shell
  script: .kitchen/provision_windows.ps1

verifier:
  name: serverspec
  remote_exec: false
  color: <%= !ENV.include?('CI') %>

transport:
  name: winrm
  username: kitchenadmin
  password: <%= ENV['KITCHEN_ADMIN_PASSWORD'] %>
  winrm_transport: :plaintext
  operation_timeout: 1800
  receive_timeout: 1810

lifecycle:
  pre_converge:
    - remote: |
        [System.Environment]::SetEnvironmentVariable('PUPPET_ROLE', '<%= ENV['PUPPET_ROLE'] %>', 'Machine')
        [System.Environment]::SetEnvironmentVariable('RONIN_REF', '<%= ENV['RONIN_REF'] %>', 'Machine')
        [System.Environment]::SetEnvironmentVariable('WORKER_POOL_ID', '<%= ENV['WORKER_POOL_ID'] %>', 'Machine')

platforms:
  - name: win11-64-24h2
    driver:
      name: azurerm
      location: 'East US 2'
      machine_size: 'Standard_F8s_v2'
      image_urn: MicrosoftWindowsDesktop:windows-11:win11-24h2-avd:latest
      # Each platform has a unique resource group name to prevent collisions when
      # CI jobs run in parallel. kitchen-azurerm appends a timestamp to this name,
      # so two jobs sharing the same base name that start within the same second
      # will land in the same resource group and conflict on the public IP resource.
      azure_resource_group_name: ronin-puppet-test-kitchen-win11-64-24h2
      use_ephemeral_osdisk: true
      deployment_timeout_in_minutes: 30
      username: kitchenadmin
      password: <%= ENV['KITCHEN_ADMIN_PASSWORD'] %>
      vm_tags:
        owner: relops@mozilla.com
        provisioner: test-kitchen-azurerm
      winrm_powershell_script: |-
        Set-NetConnectionProfile -NetworkCategory Private
        winrm quickconfig -q
        winrm set winrm/config/winrs '@{MaxMemoryPerShellMB="512"}'
        winrm set winrm/config '@{MaxTimeoutms="1800000"}'
        winrm set winrm/config/service '@{AllowUnencrypted="true"}'
        winrm set winrm/config/service/auth '@{Basic="true"}'
        winrm set winrm/config/service/auth '@{Negotiate="false"}'
  - name: win11-64-25h2
    driver:
      name: azurerm
      location: 'East US 2'
      machine_size: 'Standard_F8s_v2'
      image_urn: MicrosoftWindowsDesktop:windows-11:win11-25h2-avd:latest
      azure_resource_group_name: ronin-puppet-test-kitchen-win11-64-25h2
      use_ephemeral_osdisk: true
      deployment_timeout_in_minutes: 30
      username: kitchenadmin
      password: <%= ENV['KITCHEN_ADMIN_PASSWORD'] %>
      vm_tags:
        owner: relops@mozilla.com
        provisioner: test-kitchen-azurerm
      winrm_powershell_script: |-
        Set-NetConnectionProfile -NetworkCategory Private
        winrm quickconfig -q
        winrm set winrm/config/winrs '@{MaxMemoryPerShellMB="512"}'
        winrm set winrm/config '@{MaxTimeoutms="1800000"}'
        winrm set winrm/config/service '@{AllowUnencrypted="true"}'
        winrm set winrm/config/service/auth '@{Basic="true"}'
        winrm set winrm/config/service/auth '@{Negotiate="false"}'
  - name: win11-a64-25h2-builder
    driver:
      name: azurerm
      location: 'East US 2'
      machine_size: 'Standard_E8pds_v5'
      image_urn: MicrosoftWindowsDesktop:windows11preview-arm64:win11-25h2-ent:latest
      azure_resource_group_name: ronin-puppet-test-kitchen-win11-a64-25h2-builder
      use_ephemeral_osdisk: true
      deployment_timeout_in_minutes: 30
      username: kitchenadmin
      password: <%= ENV['KITCHEN_ADMIN_PASSWORD'] %>
      vm_tags:
        owner: relops@mozilla.com
        provisioner: test-kitchen-azurerm
      winrm_powershell_script: |-
        Set-NetConnectionProfile -NetworkCategory Private
        winrm quickconfig -q
        winrm set winrm/config/winrs '@{MaxMemoryPerShellMB="512"}'
        winrm set winrm/config '@{MaxTimeoutms="1800000"}'
        winrm set winrm/config/service '@{AllowUnencrypted="true"}'
        winrm set winrm/config/service/auth '@{Basic="true"}'
        winrm set winrm/config/service/auth '@{Negotiate="false"}'
  - name: win11-a64-25h2-tester
    driver:
      name: azurerm
      location: 'East US 2'
      machine_size: 'Standard_E8pds_v5'
      image_urn: MicrosoftWindowsDesktop:windows11preview-arm64:win11-25h2-ent:latest
      azure_resource_group_name: ronin-puppet-test-kitchen-win11-a64-25h2-tester
      use_ephemeral_osdisk: true
      deployment_timeout_in_minutes: 30
      username: kitchenadmin
      password: <%= ENV['KITCHEN_ADMIN_PASSWORD'] %>
      vm_tags:
        owner: relops@mozilla.com
        provisioner: test-kitchen-azurerm
      winrm_powershell_script: |-
        Set-NetConnectionProfile -NetworkCategory Private
        winrm quickconfig -q
        winrm set winrm/config/winrs '@{MaxMemoryPerShellMB="512"}'
        winrm set winrm/config '@{MaxTimeoutms="1800000"}'
        winrm set winrm/config/service '@{AllowUnencrypted="true"}'
        winrm set winrm/config/service/auth '@{Basic="true"}'
        winrm set winrm/config/service/auth '@{Negotiate="false"}'

suites:
  - name: windows
    verifier:
      patterns:
        - test/integration/<%= ENV['PUPPET_ROLE'] %>/serverspec/*_spec.rb
      default_pattern: false
      extra_flags: --format RspecJunitFormatter -o rspec/rspec.xml
    includes:
      - win11-64-24h2
      - win11-64-25h2
      - win11-a64-25h2-builder
      - win11-a64-25h2-tester
