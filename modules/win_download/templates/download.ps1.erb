$webclient = New-Object System.Net.WebClient
$interval = 30
$downloadStartTime = Get-Date
for ($retries = 20; $retries -gt 0; $retries--) {
    try {
        $attemptStartTime = Get-Date
        $webclient.DownloadFile('<%= @url %>', '<%= @destination_directory %>\<%= @filename %>')
        $attemptSeconds = [math]::Round(($(Get-Date) - $attemptStartTime).TotalSeconds, 2)
        Write-Host "Package downloaded in $attemptSeconds seconds"
        break
    } catch {
        $attemptSeconds = [math]::Round(($(Get-Date) - $attemptStartTime).TotalSeconds, 2)
        Write-Host "Package download failed in $attemptSeconds seconds"
        Write-Host $_.Exception.Message

        if ($_.Exception.InnerException.Response.StatusCode -eq [System.Net.HttpStatusCode]::NotFound) {
            Write-host "Request returned 404 Not Found. Aborting download."
            $retries = 0
            throw $_.Exception
        }
    }
        
    if ($retries -eq 0) {
        $totalSeconds = [math]::Round(($(Get-Date) - $downloadStartTime).TotalSeconds, 2)
        throw "Package download failed after $totalSeconds seconds"
    }

    Write-Warning "Waiting $interval seconds before retrying (retries left: $retries)..."
    Start-Sleep -Seconds $interval
}
