# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.
#
# Init script for Xsession service

[Unit]
Description=Xsession service.
# Start Xsession only after x11 or xvfb start
After=<%= if @on_gpu == true then "x11.service" else "xvfb.service" end %>

[Service]
TimeoutSec=5min
IgnoreSIGPIPE=no
KillMode=process
GuessMainPID=no
# v1
# ExecStart=/bin/su - -c "DISPLAY=:0 /etc/X11/Xsession" <%= @builder_user %>
#
# v2
#  - didn't work either. same problem. (non ubuntu session that can't launch apps)
ExecStart=/bin/su - -c "DISPLAY=:0 /usr/local/bin/gnome_headless_session.sh" <%= @builder_user %>
#
# v3: use systemd-run
#   sudo -u cltbld XDG_RUNTIME_DIR=/run/user/$(id -u cltbld) \
#     systemd-run --user --scope /usr/local/bin/gnome_headless_session.sh
#
ExecStart=/bin/sudo -u cltbld systemd-run --user --scope /usr/local/bin/gnome_headless_session.sh
# why do we need this also now? above is starting a gnome-session
# ExecStartPost=/bin/su - -c "systemctl --user start gnome-session-x11.service" <%= @builder_user %>

[Install]
WantedBy=multi-user.target
