---
language: ruby
dist: xenial
rvm:
  - 2.6

sudo: required
services: docker

before_install:
  - gem update --system
  - gem install bundler

gemfile: ".gemfile"

env:
  - KITCHEN_TARGET=bitbar
  - KITCHEN_TARGET=linux

stages:
  - parse
  - lint
  - install_r10k_modules
  - test-kitchen

jobs:
  include:
    - stage: parse
      env: KITCHEN_TARGET=none
    - script: "bundle exec puppet parser validate `find modules -name '*.pp'`"
    - stage: lint
      env: KITCHEN_TARGET=none
    - script: "bundle exec puppet-lint --fail-on-warnings `find modules -name '*.pp'`"
    - stage: install_r10k_modules
      env: KITCHEN_TARGET=none
    - script: "bundle exec r10k puppetfile install --moduledir=/tmp/r10k_module_test -v --force"
    - stage: test-kitchen
    - script: "KITCHEN_YAML=.kitchen.docker.yml bundle exec kitchen verify $KITCHEN_TARGET"

