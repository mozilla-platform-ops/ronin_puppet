---
language: ruby
dist: xenial
rvm:
  - 2.6

os: linux
services: docker

before_install:
  - gem update --system
  - gem install bundler

gemfile: ".gemfile"

env:
  - KITCHEN_TARGET=bitbar
  - KITCHEN_TARGET=linux
  - KITCHEN_TARGET=maas-region
  - KITCHEN_TARGET=maas-rack

stages:
  - analysis
  - test

script: 
  - KITCHEN_YAML=.kitchen.docker.yml bundle exec kitchen converge $KITCHEN_TARGET
  - KITCHEN_YAML=.kitchen.docker.yml bundle exec kitchen verify $KITCHEN_TARGET

jobs:
  include:
    - stage: analysis
      env: KITCHEN_TARGET=none
      name: "puppet parser validate"
      script: bundle exec puppet parser validate `find modules -name '*.pp'`
    - env: KITCHEN_TARGET=none
      name: "puppet lint"
      script: bundle exec puppet-lint --fail-on-warnings `find modules -name '*.pp'`
    - env: KITCHEN_TARGET=none
      name: "r10k puppetfile install"
      script: bundle exec r10k puppetfile install --moduledir=/tmp/r10k_module_test -v --force


